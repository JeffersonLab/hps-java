<?xml version="1.0" encoding="UTF-8"?>
<lccdd xmlns:compact="http://www.lcsim.org/schemas/compact/1.0"
       xmlns:xs="http://www.w3.org/2001/XMLSchema-instance"
       xs:noNamespaceSchemaLocation="http://www.lcsim.org/schemas/compact/1.0/compact.xsd">
  
  <info name="HPS-HodoscopeTest-v1">
    <comment>HPS detector for 2019 run with fieldmap,
    Tracker at nominal opening angle, no SVT survey,  
    this detector uses the corrected fieldmap scaled to -1.022T for 4.5 GeV.
    Includes L0 and Hodoscope.
    </comment>
  </info>
  
  <define>
    
    <!-- world -->
    <constant name="world_side" value="500.0*cm" />
    <constant name="world_x" value="world_side" />
    <constant name="world_y" value="world_side" />
    <constant name="world_z" value="world_side" />
    
    <!-- beam -->
    <constant name="beam_angle" value="0.03052"/> <!--30.52 mrad-->
    
    <!-- tracking region -->
    <constant name="tracking_region_radius" value="200.0*cm"/>
    <constant name="tracking_region_min" value="5.0*cm"/>
    <constant name="tracking_region_zmax" value="136.8*cm"/>
    
    <!--  dipole magnet and  B-field -->
    <constant name="dipoleMagnetPositionX" value="2.117*cm"/>
    <constant name="dipoleMagnetPositionZ" value="45.72*cm"/>
    <constant name="dipoleMagnetHeight" value="100*cm"/>
    <constant name="dipoleMagnetWidth" value="100*cm"/>
    <constant name="dipoleMagnetLength" value="108*cm"/>
    <constant name="constBFieldY" value="-1.08"/><!-- set for 4.5GeV running -->
    
    
    <!-- ECAL crystal dimensions -->
    <constant name="ecal_front" value="13.3/2*mm" />
    <constant name="ecal_back" value="16/2*mm" />
    <constant name="ecal_z" value="160/2*mm" />
    
    <!-- ECal Z position -->
    <!-- Old position without hodo :<constant name="ecal_dface" value="139.3*cm"/> -->
    <constant name="ecal_dface" value="144.3*cm" /> <!-- plus 5 cm -->
    
    <!-- ECal placement parameters for NEW ECAL -->
    <constant name="beam_angle" value="0.03052"/>
    <constant name="ecal_front" value="13.3/2*mm" />
    <constant name="ecal_back" value="16/2*mm" />
    <constant name="ecal_z" value="160/2*mm" />
    <!-- ECal Modules translation parameters -->
    <constant name="top_tr_x" value="-0.71"/>
    <constant name="top_tr_y" value="2.725"/>
    <constant name="top_tr_z" value="4.9375"/>
    <constant name="bot_tr_x" value="-0.405"/>
    <constant name="bot_tr_y" value="-0.9125"/>
    <constant name="bot_tr_z" value="2.6225"/>
    <!-- ECal Modules rotation parameters(Rz(alpha)Ry(beta)Rx(gamma)) -->
    <constant name="top_rot_alpha" value="0.00064964212772"/>
    <constant name="top_rot_beta" value="0.0"/>
    <constant name="top_rot_gamma" value="-0.00046882347412"/>
    <constant name="bot_rot_alpha" value="0.0005150274940439"/>
    <constant name="bot_rot_beta" value="0.0"/>
    <constant name="bot_rot_gamma" value="0.0013469727279283583"/>

    <!-- HODOSCOPE PARAMETERS -->
    <!-- Hodoscope thickness -->
    <constant name="hodoscopeXMin1" value="48-4.452"/>
    <constant name="hodoscopeXMin2" value="48"/>
    <constant name="hodoscopeThickness" value="10*mm"/>
    <constant name="hodoscopePixelHeight" value="59.225*mm"/>
    
    <!-- Distance between hodoscope and scoring planes -->
    <constant name="hodoscopeScoreDisplacement" value="1.000"/>
    <constant name="hodoscopeZ" value="1098.5*mm" />


    <!-- SVT PARAMETERS -->    
    <!-- SVT module dimensions -->
    <constant name="moduleLength" value="100.0"/>
    <constant name="moduleWidth" value="40.34"/>
    
    <!-- SVT sensor dimensions -->
    <constant name="sensorLength" value="98.33"/>
    
    <!--scoring plane thickness-->
    <constant name="scoringThickness" value="0.001"/>
    
    <!--left and right edges of the electron gap for the ECal scoring plane, measured as distances from the BL edge of the flange-->
    <constant name="electronGapLeftEdge" value="382.16+20*0.0166"/>
    <constant name="electronGapRightEdge" value="471.94+20*0.1511"/>
    
    <!-- Sensor width slightly less than 38.34 mm so sisim works. -->
    <constant name="sensorWidth" value="38.3399"/>
    <constant name="zst" value="1" />
    <constant name="SA1" value="0.1" />
    <constant name="SA2" value="0.05" />
    <constant name="PI" value="3.14159265359" />
    <!-- positions derived from drawing assuming 1.35/1.2 degress open on top/bottom -->
    
    <constant name="x_rot_top" value="0" />  
    <constant name="x_rot_bot" value="0" />    
    
    <!--  monkey with the rotations  -->    
    <constant name="x_rot_top_add" value="0.00" />  <!-- -ive means further closed -->
    <constant name="x_rot_bot_add" value="0.00" /> <!-- +ive means further closed -->
    <!--  distance from target to pivot...this is from an email schematic from Tim on may 12, 2012 -->
    <constant name="pivot" value="791" /> 
    
    <constant name="y_rot" value = "beam_angle"/>
    <!--        <constant name="x_off" value = "-15.0"/> -->
    <constant name="x_off" value = "0.0"/> 
    
    <!-- Positions of thin 15 cm planes -->
    <constant name="y01t" value="150*sin(0.015)+sensorWidth/2" />
    <constant name="y02t" value="150*sin(0.015)+sensorWidth/2" />
    <constant name="y01b" value="-(150*sin(0.015)+sensorWidth/2)" />
    <constant name="y02b" value="-(150*sin(0.015)+sensorWidth/2)" />
    
    <constant name="z01t" value="0+142.5-3.685" />
    <constant name="z02t" value="0+142.5+3.685" />
    <constant name="z01b" value="0+157.5-3.685" />
    <constant name="z02b" value="0+157.5+3.685" />
    
  </define>
  
  <materials>
    <!-- Set the world material to vacuum. -->
    <material name="WorldMaterial">
      <D type="density" unit="g/cm3" value="0.0000000000000001"/>
      <fraction n="1.0" ref="Vacuum" />
    </material>
    <!-- Set tracking material to vacuum. -->
    <material name="TrackingMaterial">
      <D type="density" unit="g/cm3" value="0.0000000000000001"/>
      <fraction n="1.0" ref="Vacuum" />
    </material>
    <!-- ECal crystal material. -->
    <material name="LeadTungstate">
      <D value="8.28" unit="g/cm3"/>
      <composite n="1" ref="Pb"/>
      <composite n="1" ref="W"/>
      <composite n="4" ref="O"/>
    </material>
    <!-- Hodoscope material. -->
    <material name="EJ204_PlasticScintillator">
      <D value="1.032" unit="g/cm3"/>
      <fraction n="0.523618" ref="H"/>
      <fraction n="0.476382" ref="C"/>
    </material>
    <material name="TitaniumDioxide">
      <D value="4.23" unit="g/cm3" />
      <composite n="1" ref="Ti" />
      <composite n="2" ref="O" />
    </material>
    <material name="Mylar">
      <D value="1.4" unit="g/cm3" />
      <fraction n="0.041958" ref="H"/>
      <fraction n="0.625017" ref="C"/>
      <fraction n="0.333025" ref="O"/>
    </material>
    <material name="GenericFoam">
      <D value="0.052" unit="g/cm3" />
      <fraction n="0.5" ref="H"/>
      <fraction n="0.5" ref="C"/>
    </material>
  </materials>

  
  <display>
    <vis name="ECALVis" r="0.8" g="0.5" b="0.1" />    
    <vis name="HodoscopeVis" alpha="1.0" r="0.0" g="0.33725490196" b="0.50980392156" drawingStyle="solid" visible="true" />	
    <vis name="ChamberVis" alpha="1.0" r="1.0" g="0.0" b="1.0" drawingStyle="wireframe" lineStyle="unbroken" showDaughters="true" visible="true"/>
    <vis name="SvtBoxVis" alpha="1.0" r="1.0" g="1.0" b="0.0" drawingStyle="wireframe" lineStyle="unbroken" showDaughters="true" visible="true"/>
    <vis name="SensorVis" alpha="1.0" r="1.0" g="0.0" b="0.0" drawingStyle="wireframe" lineStyle="unbroken" showDaughters="true" visible="true"/>
    <vis name="ActiveSensorVis" alpha="1.0" r="1.0" g="0.0" b="0.0" drawingStyle="solid" lineStyle="unbroken" showDaughters="true" visible="true"/>
    <vis name="CarbonFiberVis" alpha="1.0" r="0.88" g="0.88" b="0.88" drawingStyle="solid" lineStyle="unbroken" showDaughters="true" visible="true"/>
    <vis name="KaptonVis" alpha="1.0" r="0.91" g="0.77" b="0.06" drawingStyle="solid" lineStyle="unbroken" showDaughters="true" visible="true"/>
    <vis name="HybridVis" alpha="1.0" r="0.0" g="1.0" b="0" drawingStyle="solid" lineStyle="unbroken" showDaughters="true" visible="true"/>
    <vis name="HalfModuleVis" alpha="1.0" r="1.0" g="1.0" b="1.0" drawingStyle="wireframe" lineStyle="dashed" showDaughters="true" visible="true"/>
    <vis name="ColdBlockVis" alpha="1.0" r="0.75" g="0.73" b="0.75" drawingStyle="solid" lineStyle="dashed" showDaughters="true" visible="true"/>
    <vis name="ModuleVis" alpha="1.0" r="1.0" g="1.0" b="1.0" drawingStyle="wireframe" lineStyle="dotted" showDaughters="true" visible="true"/>
    <vis name="SupportPlateVis" alpha="1.0" r="0.45" g="0.45" b="0.45" drawingStyle="solid" lineStyle="dashed" showDaughters="true" visible="true"/>
    <vis name="SupportVolumeVis" alpha="1.0" r="0.75" g="0.73" b="0.75" drawingStyle="wireframe" lineStyle="dashed" showDaughters="true" visible="true"/>
    <vis name="BasePlateVis" alpha="1.0" r="0.35" g="0.35" b="0.35" drawingStyle="solid" lineStyle="dashed" showDaughters="true" visible="true"/>
    <vis name="LayerVis" alpha="0.0" r="0.0" g="0.0" b="1.0" drawingStyle="wireframe" showDaughters="true" visible="false"/>
    <vis name="ComponentVis" alpha="0.0" r="0.0" g="0.2" b="0.4" drawingStyle="solid" showDaughters="false" visible="false"/>
    <vis name="BeamPlaneVis" alpha="1.0" r="1.0" g="1.0" b="1.0" drawingStyle="solid" lineStyle="unbroken" showDaughters="false" visible="true"/>
  </display>
  
  <detectors>
    
    <detector id="29" name="ECalScoring" type="HPSTracker2" readout="TrackerHitsECal" insideTrackingVolume="false" >
      <comment>Scoring plane after ECal flange for calibration studies</comment>
      <module name="BeamLeft">
        <box x="electronGapLeftEdge" y="457.2/2-17" />
        <module_component thickness="scoringThickness" material = "Vacuum" sensitive="true"/>
      </module>            
      <module name="ElectronGap">
        <box x="electronGapRightEdge-electronGapLeftEdge" y="(457.2-64.66)/2" />
        <module_component thickness="scoringThickness" material = "Vacuum" sensitive="true"/>
      </module>            
      <module name="BeamRight">
        <box x="768.35-electronGapRightEdge" y="457.2/2-14" />
        <module_component thickness="scoringThickness" material = "Vacuum" sensitive="true"/>
      </module>            
      <layer id="1"><!--top-->
        <module_placement name="BeamLeft" id="0" x="(768.35-electronGapLeftEdge)/2+21.17" y="(457.2/2+17)/2" z="1318+70+scoringThickness" rx="0" ry="0" rz="-PI/2"/>
        <module_placement name="ElectronGap" id="0" x="768.35/2-electronGapRightEdge+(electronGapRightEdge-electronGapLeftEdge)/2+21.17" y="(457.2/2+64.66/2)/2" z="1318+70+scoringThickness" rx="0" ry="0" rz="-PI/2"/>
        <module_placement name="BeamRight" id="0" x="-1*electronGapRightEdge/2+21.17" y="(457.2/2+14)/2" z="1318+70+scoringThickness" rx="0" ry="0" rz="-PI/2"/>
      </layer>
      <layer id="2"><!--bottom-->
        <module_placement name="BeamLeft" id="0" x="(768.35-electronGapLeftEdge)/2+21.17" y="-1*(457.2/2+17)/2" z="1318+70+scoringThickness" rx="0" ry="0" rz="-3*PI/2"/>
        <module_placement name="ElectronGap" id="0" x="768.35/2-electronGapRightEdge+(electronGapRightEdge-electronGapLeftEdge)/2+21.17" y="-1*(457.2/2+64.66/2)/2" z="1318+70+scoringThickness" rx="0" ry="0" rz="-3*PI/2"/>
        <module_placement name="BeamRight" id="0" x="-1*electronGapRightEdge/2+21.17" y="-1*(457.2/2+14)/2" z="1318+70+scoringThickness" rx="0" ry="0" rz="-3*PI/2"/>
      </layer>
    </detector> 

    <detector id="30" name="Hodoscope" type="Hodoscope_v1" readout="HodoscopeHits" insideTrackingVolume="true" vis="HodoscopeVis">
      <!--
	  It is mandatory to define hodoscope crystal materials!
      -->
      <scintillator_material value="Polystyrene" />
      <cover_material value="TitaniumDioxide" />
      <reflector_material value="Mylar" />
      <buffer_material value="Carbon" />
      
      <!--
	  These variables allow the hodoscope to be shifted
	  without modification of the code. These variables do
	  NOT need to be specified. If they are not declared,
	  the nominal value will used instead. Note that any
	  combination of these variables can be declared or
	  excluded freely.
      -->
      <layer1_top_x value="44.56*mm" />
      <layer1_top_y value="14.2*mm" />
      <layer1_top_z value="hodoscopeZ" />
      <layer1_bot_x value="44.56*mm" />
      <layer1_bot_y value="14.2*mm" />
      <layer1_bot_z value="hodoscopeZ" />
      
      <layer2_top_x value="47.9*mm" />
      <layer2_top_y value="14.2*mm" />
      <layer2_bot_x value="47.9*mm" />
      <layer2_bot_y value="14.2*mm" />
      
      <scintillator_depth value="9.5*mm" />
      <scintillator_depth_height value="59.9*mm" />
      <cover_depth value="0.25*mm" />
      <reflector_depth value="0.05*mm" />
      
      <buffer_depth value="2*mm" />
      <buffer_width value="187.64*mm" />
      <buffer_x value="39.0*mm" />
      
      <!--
	  Defines the hodoscope pixel widths and count. One
	  pixel will be added to the specified hodoscope layer
	  for each entry in the list below. The pixel will be
	  of the specified width in millimeters. Note that the
	  top and bottom parts of the hodoscope will use the
	  same set of widths. It is not necessary to define
	  these arguments.
      -->
      <scintillator_width_layer1 value="15.7,34.1,44,44,44" />
      <scintillator_width_layer2 value="19,44,44,44,30.8" />
    </detector>
    
    
    <!--  OLDER ECAL -->
    <detector id="13" name="Ecal" type="HPSEcal3" insideTrackingVolume="false" readout="EcalHits" vis="ECALVis">
      <comment>The crystal ECal</comment>
      <material name="LeadTungstate" />
      <dimensions x1="ecal_front" y1="ecal_front" x2="ecal_back" y2="ecal_back" z="ecal_z" />          
      <layout beamgap="20.0*mm" nx="46" ny="5" dface="ecal_dface">
        <remove ixmin="-10" ixmax="-2" iymin="-1" iymax="1" />
        <top dx="ecal_dface*tan(beam_angle)" dy="0." dz="0."/>
        <bottom dx="ecal_dface*tan(beam_angle)" dy="0." dz="0."/>
      </layout>
    </detector>
  </detectors>
  <!-- New adjustable ECAL -->
  <!--
      <detector id="13" name="Ecal" type="HPSEcal4" insideTrackingVolume="false" readout="EcalHits" vis="ECALVis">
      <comment>The crystal ECal</comment>
      <material name="LeadTungstate" />
      <dimensions x1="ecal_front" y1="ecal_front" x2="ecal_back" y2="ecal_back" z="ecal_z" /> 
      <translations top_tr_x="top_tr_x" top_tr_y="top_tr_y" top_tr_z="top_tr_z" bot_tr_x="bot_tr_x" bot_tr_y="bot_tr_y" bot_tr_z="bot_tr_z" />
      <rotations top_rot_alpha="top_rot_alpha" top_rot_beta="top_rot_beta" top_rot_gamma="top_rot_gamma" bot_rot_alpha="bot_rot_alpha" bot_rot_beta="bot_rot_beta" bot_rot_gamma="bot_rot_gamma" />          
      <layout beamgap="20.0*mm" nx="46" ny="5" dface="ecal_dface">
      <remove ixmin="-10" ixmax="-2" iymin="-1" iymax="1" />
      <top dx="ecal_dface*tan(beam_angle)" dy="0." dz="0."/>
      <bottom dx="ecal_dface*tan(beam_angle)" dy="0." dz="0."/>
      </layout>
      </detector>
  -->
  
  <readouts>   
    <readout name="TrackerHits">
      <id>system:6,barrel:3,layer:4,module:12,sensor:1,side:32:-2,strip:12</id> 
    </readout>
    <readout name="TrackerHitsFieldDef">
      <id>system:6,barrel:3,layer:4,module:12,sensor:1,side:32:-2,strip:12</id> 
      <processor type="ScoringTrackerHitProcessor" />        
    </readout>
    <readout name="TrackerHitsECal">
      <id>system:6,barrel:3,layer:4,module:12,sensor:1,side:32:-2,strip:12</id> 
      <processor type="ScoringTrackerHitProcessor" />        
    </readout>
    <readout name="HodoscopeHits">
      <id>system:6,barrel:3,layer:4,ix:4,iy:-3,hole:-3</id>
    </readout>
    <readout name="HodoscopeForeHits">
      <id>system:6,barrel:3,layer:4,module:12,sensor:1,side:32:-2,strip:12</id>
      <processor type="ScoringTrackerHitProcessor"/>
    </readout>
    <readout name="EcalHits">
      <segmentation type="GridXYZ" gridSizeX="0.0" gridSizeY="0.0" gridSizeZ="0.0" />
      <id>system:6,layer:2,ix:-8,iy:-6</id>
    </readout>
    
  </readouts>
  
  <fields>
    <field 
        type="FieldMap3D"
        name="HPSDipoleFieldMap3D" 
        filename="fieldmap/418acm2_10kg_corrected_unfolded_scaled_1.0319.dat" 
        url="https://raw.githubusercontent.com/JeffersonLab/hps-fieldmaps/master/418acm2_10kg_corrected_unfolded_scaled_1.0319.tar.gz"
        xoffset="2.117*cm"
        yoffset="0.0*cm"
        zoffset="45.72*cm"
        />
  </fields>
  
  <!--    
       <fields>
       <field type="BoxDipole" name="AnalyzingDipole" x="dipoleMagnetPositionX" y="0*cm" z="dipoleMagnetPositionZ" dx="dipoleMagnetWidth/2.0" dy="dipoleMagnetHeight/2.0" dz="dipoleMagnetLength/2.0" bx="0.0" by="constBFieldY" bz="0.0" />
       </fields>
  -->
  <includes>
    <gdmlFile file="gdml/ecal_vacuum_flange_complete_v3.gdml" /> 
    <gdmlFile file="gdml/hps_hodoscope_assembly.gdml" /> 
    <gdmlFile file="gdml/svt_chamber_v2.gdml" />
  </includes>
</lccdd>
